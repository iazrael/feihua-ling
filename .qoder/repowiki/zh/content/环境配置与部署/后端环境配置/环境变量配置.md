# 环境变量配置

<cite>
**本文引用的文件**
- [backend/prisma.config.ts](file://backend/prisma.config.ts) - *更新了数据库URL环境变量配置*
- [backend/prisma/schema.prisma](file://backend/prisma/schema.prisma) - *使用PRISMA_DATABASE_URL环境变量*
- [backend/src/index.ts](file://backend/src/index.ts) - *兼容两种数据库URL环境变量*
- [backend/package.json](file://backend/package.json) - *包含Prisma相关依赖*
</cite>

## 更新摘要
**变更说明**
- 更新了环境变量配置说明，明确区分 `DATABASE_URL` 与 `PRISMA_DATABASE_URL` 的使用场景
- 新增对 `PRISMA_DATABASE_URL` 在 `schema.prisma` 和 `src/index.ts` 中的应用说明
- 调整架构图以反映双环境变量机制
- 更新故障排查指南以涵盖新旧变量共存情况

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能与稳定性建议](#性能与稳定性建议)
8. [故障排查指南](#故障排查指南)
9. [结论](#结论)

## 简介
本文面向后端开发者，系统性说明如何通过环境变量配置数据库连接。重点围绕两个关键环境变量：`DATABASE_URL`（用于Prisma CLI和prisma.config.ts）与 `PRISMA_DATABASE_URL`（用于运行时连接）。文档详细解释 `backend/.env` 文件中这两个变量的设置方式（如 `file:./dev.db`），以及它们在 `prisma.config.ts` 中通过 dotenv/config 加载，并由Prisma的 `env()` 函数或Node.js `process.env` 读取的过程。同时说明如何正确配置以确保Prisma能够连接到SQLite或PostgreSQL数据库，避免因变量混淆或路径错误导致的连接失败。

## 项目结构
后端采用 Prisma 作为 ORM，开发环境使用 SQLite，生产环境使用 PostgreSQL。关键配置文件如下：
- 环境变量文件：backend/.env（需手动创建）
- Prisma 配置：backend/prisma.config.ts（使用 DATABASE_URL）
- 数据库模式定义：backend/prisma/schema.prisma（使用 PRISMA_DATABASE_URL）
- 启动入口：backend/src/index.ts（兼容两种环境变量）
- 依赖声明：backend/package.json

```mermaid
graph TB
subgraph "后端"
ENV[".env<br/>环境变量"]
PCFG["prisma.config.ts<br/>Prisma 配置<br/>(读取 DATABASE_URL)"]
SCHEMA["schema.prisma<br/>数据源与模型<br/>(读取 PRISMA_DATABASE_URL)"]
IDX["src/index.ts<br/>应用入口<br/>(优先使用 PRISMA_DATABASE_URL)"]
PKG["package.json<br/>依赖与脚本"]
end
ENV --> PCFG
ENV --> IDX
PCFG --> SCHEMA
IDX --> SCHEMA
PKG --> PCFG
PKG --> IDX
```

**图表来源**
- [backend/prisma.config.ts](file://backend/prisma.config.ts#L1-L14)
- [backend/prisma/schema.prisma](file://backend/prisma/schema.prisma#L1-L19)
- [backend/src/index.ts](file://backend/src/index.ts#L1-L373)

## 核心组件
- 环境变量文件 backend/.env：存放 DATABASE_URL 和 PRISMA_DATABASE_URL，分别用于Prisma工具链和运行时。
- Prisma 配置 backend/prisma.config.ts：通过 dotenv/config 自动加载 .env；使用 env("DATABASE_URL") 读取变量，用于Prisma CLI操作。
- 数据库模式 backend/prisma/schema.prisma：定义数据源URL来自环境变量 PRISMA_DATABASE_URL。
- 应用入口 backend/src/index.ts：创建 PrismaClient 时优先使用 PRISMA_DATABASE_URL，兼容旧配置。
- 依赖声明 backend/package.json：包含 prisma、@prisma/client、sqlite3 等依赖，保证运行时可用。

**章节来源**
- [backend/prisma.config.ts](file://backend/prisma.config.ts#L1-L14)
- [backend/prisma/schema.prisma](file://backend/prisma/schema.prisma#L1-L19)
- [backend/src/index.ts](file://backend/src/index.ts#L1-L373)
- [backend/package.json](file://backend/package.json#L1-L37)

## 架构总览
下图展示从环境变量到数据库连接的关键链路，区分了Prisma CLI工具链与运行时应用的不同配置路径。

```mermaid
flowchart TD
subgraph "Prisma CLI 工具链"
PCFG["prisma.config.ts\n读取 DATABASE_URL"]
CLI["Prisma CLI\n(migrate, generate)"]
end
subgraph "运行时应用"
IDX["src/index.ts\n读取 PRISMA_DATABASE_URL"]
CLIENT["PrismaClient\n运行时连接"]
end
ENV[".env\n包含两个变量"]
SCHEMA["schema.prisma\n定义数据源"]
ENV --> PCFG
ENV --> IDX
PCFG --> CLI
PCFG --> SCHEMA
IDX --> CLIENT
SCHEMA --> CLIENT
style PCFG fill:#e1f5fe
style IDX fill:#e8f5e8
```

**图表来源**
- [backend/prisma.config.ts](file://backend/prisma.config.ts#L1-L14)
- [backend/prisma/schema.prisma](file://backend/prisma/schema.prisma#L1-L19)
- [backend/src/index.ts](file://backend/src/index.ts#L1-L373)

## 详细组件分析

### 环境变量 DATABASE_URL 与 PRISMA_DATABASE_URL 的设置与作用
- **设置位置**：backend/.env（需手动创建）
- **DATABASE_URL 示例**：file:./dev.db
  - **作用**：供Prisma CLI（如migrate, generate）和prisma.config.ts使用，指定数据库连接。
  - **使用场景**：开发环境数据库操作、模式迁移。
- **PRISMA_DATABASE_URL 示例**：postgresql://user:pass@localhost:5432/dbname 或 file:./dev.db
  - **作用**：供运行时应用（src/index.ts）使用，建立实际数据库连接。
  - **使用场景**：应用启动时的数据库连接。
- **注意事项**：
  - 两个变量可指向不同数据库，实现开发与运行环境分离。
  - 使用 file: 前缀表示SQLite文件路径。
  - 相对路径基于当前工作目录解析；建议使用明确的相对路径或绝对路径。
  - 确保目标目录存在且具备读写权限。

**章节来源**
- [backend/prisma.config.ts](file://backend/prisma.config.ts#L1-L14)
- [backend/src/index.ts](file://backend/src/index.ts#L1-L373)

### Prisma 配置加载流程（prisma.config.ts）
- **加载机制**：通过 `import "dotenv/config";` 在模块初始化时自动加载 .env。
- **变量读取**：`env("DATABASE_URL")` 将 .env 中的 DATABASE_URL 注入到数据源配置。
- **数据源配置**：将 url 字段绑定到 `env("DATABASE_URL")`，影响Prisma CLI工具链的行为。

```mermaid
flowchart TD
Start["启动 prisma.config.ts"] --> LoadEnv["加载 .env (dotenv/config)"]
LoadEnv --> ReadVar["读取 DATABASE_URL env('DATABASE_URL')"]
ReadVar --> ApplyCfg["写入数据源 url 字段"]
ApplyCfg --> End["完成配置"]
```

**图表来源**
- [backend/prisma.config.ts](file://backend/prisma.config.ts#L1-L14)

**章节来源**
- [backend/prisma.config.ts](file://backend/prisma.config.ts#L1-L14)

### 数据库模式（schema.prisma）
- **提供程序**：postgresql（生产）或 sqlite（开发）
- **数据源 URL**：来自 `env("PRISMA_DATABASE_URL")`，即 .env 中的 PRISMA_DATABASE_URL
- **模型**：Poem（标题、作者、内容、朝代等字段）

```mermaid
erDiagram
POEM {
int id PK
string title
string author
string content
string dynasty
}
```

**图表来源**
- [backend/prisma/schema.prisma](file://backend/prisma/schema.prisma#L1-L19)

**章节来源**
- [backend/prisma/schema.prisma](file://backend/prisma/schema.prisma#L1-L19)

### 应用入口与 Prisma 客户端
- **创建 PrismaClient 实例**，优先使用 `process.env.PRISMA_DATABASE_URL`，回退到 `file:./dev.db`。
- 通过 Express 提供 REST 接口，内部调用 Prisma 查询/写入。
- 该客户端在运行时会依据环境变量与 schema.prisma 的数据源设置进行连接。

```typescript
const prisma = new PrismaClient({
  datasources: {
    db: {
      url: process.env.PRISMA_DATABASE_URL || 'file:./dev.db'
    }
  }
});
```

**章节来源**
- [backend/src/index.ts](file://backend/src/index.ts#L1-L373)

## 依赖关系分析
- package.json 声明了 prisma、@prisma/client、sqlite3 等依赖，确保 Prisma 工具链与运行时可用。
- prisma.config.ts 依赖 dotenv/config，负责加载 .env 并读取 DATABASE_URL。
- schema.prisma 依赖 env("PRISMA_DATABASE_URL")，将变量注入到数据源。
- src/index.ts 依赖 @prisma/client，创建 PrismaClient 并优先使用 PRISMA_DATABASE_URL 进行连接。

```mermaid
graph LR
PKG["package.json"] --> PCFG["prisma.config.ts"]
PKG --> IDX["src/index.ts"]
PCFG --> SCHEMA["schema.prisma"]
ENV[".env"] --> PCFG
ENV --> IDX
SCHEMA --> IDX
```

**图表来源**
- [backend/package.json](file://backend/package.json#L1-L37)
- [backend/prisma.config.ts](file://backend/prisma.config.ts#L1-L14)
- [backend/prisma/schema.prisma](file://backend/prisma/schema.prisma#L1-L19)
- [backend/src/index.ts](file://backend/src/index.ts#L1-L373)

## 性能与稳定性建议
- **变量分离**：使用 DATABASE_URL 用于开发操作，PRISMA_DATABASE_URL 用于运行时，避免冲突。
- **路径稳定性**：优先使用绝对路径或明确的相对路径，避免因工作目录变化导致的连接失败。
- **文件权限**：确保数据库文件所在目录具备读写权限，防止连接或迁移阶段出现权限错误。
- **环境隔离**：在不同环境使用不同的 PRISMA_DATABASE_URL，避免混用导致并发写入冲突。
- **连接池**：生产环境使用PostgreSQL时，合理配置连接池大小。

## 故障排查指南
- **连接失败（找不到文件或无权限）**
  - 检查 PRISMA_DATABASE_URL 是否指向正确的数据库路径或连接字符串。
  - 确认目标文件存在且具备读写权限（SQLite）或数据库服务正在运行（PostgreSQL）。
  - 若使用相对路径，确认运行时工作目录与预期一致。
  - 参考路径解析与权限相关实现位置：
    - 环境变量设置：[backend/.env](file://backend/.env)
    - 配置加载与变量读取：[backend/prisma.config.ts](file://backend/prisma.config.ts#L1-L14)
    - 数据源注入：[backend/prisma/schema.prisma](file://backend/prisma/schema.prisma#L1-L19)
    - 运行时连接：[backend/src/index.ts](file://backend/src/index.ts#L1-L373)
- **迁移失败**
  - 确认使用的是 DATABASE_URL 而非 PRISMA_DATABASE_URL。
  - 检查迁移目录与锁文件状态，避免并发冲突。
  - 参考依赖声明与脚本命令：
    - 依赖与脚本：[backend/package.json](file://backend/package.json#L1-L37)
- **运行时连接异常**
  - 确认应用启动时已加载 .env（dotenv/config）。
  - 检查 PrismaClient 初始化是否成功，日志中是否显示正确的连接URL。
  - 参考应用入口与客户端初始化：
    - 应用入口与 PrismaClient：[backend/src/index.ts](file://backend/src/index.ts#L1-L373)

## 结论
通过在 backend/.env 中同时设置 DATABASE_URL（供Prisma CLI使用）和 PRISMA_DATABASE_URL（供运行时使用），可以实现开发与运行环境的分离。prisma.config.ts 通过 dotenv/config 加载 .env 并使用 env("DATABASE_URL") 进行配置，而 src/index.ts 则通过 process.env.PRISMA_DATABASE_URL 创建 PrismaClient。这种双变量机制提高了配置灵活性和安全性。为确保稳定运行，建议明确区分两个变量的用途，统一管理不同环境的连接字符串，并在出现问题时按“故障排查指南”逐项检查。