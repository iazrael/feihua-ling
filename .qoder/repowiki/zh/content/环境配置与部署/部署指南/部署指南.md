# 部署指南

<cite>
**本文引用的文件**
- [backend/package.json](file://backend/package.json) - *更新了构建脚本以支持 Vercel 部署*
- [backend/src/index.ts](file://backend/src/index.ts) - *Express 服务与路由实现*
- [backend/prisma.config.ts](file://backend/prisma.config.ts) - *Prisma 配置文件，支持 PostgreSQL*
- [backend/prisma/schema.prisma](file://backend/prisma/schema.prisma) - *数据模型定义，使用 PostgreSQL 作为数据库提供者*
- [backend/prisma/migrations/migration_lock.toml](file://backend/prisma/migrations/migration_lock.toml) - *迁移锁文件，指定 PostgreSQL 提供者*
- [frontend/package.json](file://frontend/package.json) - *前端构建脚本配置*
- [frontend/vite.config.ts](file://frontend/vite.config.ts) - *Vite 构建配置*
- [frontend/.env.production](file://frontend/.env.production) - *前端生产环境变量*
- [vercel.json](file://vercel.json) - *Vercel 部署配置文件*
- [deploy-prepare.sh](file://deploy-prepare.sh) - *自动化部署准备脚本*
- [DEPLOY.md](file://DEPLOY.md) - *详细的 Vercel 部署指南*
</cite>

## 更新摘要
**变更内容**
- 将数据库从 SQLite 迁移至 PostgreSQL，更新了 Prisma 配置和环境变量
- 新增 Vercel 部署方案，支持一键部署和自动化流程
- 添加 `vercel.json` 部署配置和 `deploy-prepare.sh` 自动化脚本说明
- 更新环境变量名称为 `PRISMA_DATABASE_URL` 以适配生产环境安全要求
- 移除本地数据库文件依赖，强调远程数据库配置

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能与稳定性建议](#性能与稳定性建议)
8. [故障排查指南](#故障排查指南)
9. [结论](#结论)
10. [附录](#附录)

## 简介
本指南面向生产环境部署，提供前后端分离部署方案，并重点更新了从 SQLite 到 PostgreSQL 的数据库迁移内容。前端通过 `npm run build` 生成静态产物，可由 Nginx 或 Vite 静态服务器托管；后端在服务器上安装 Node.js 环境，构建并启动 Express 服务（`npm start`），确保 `PRISMA_DATABASE_URL` 指向生产级 PostgreSQL 数据库。文档新增 Vercel 云平台的一键部署配置与自动化脚本说明，强调前后端部署路径的协调，如通过反向代理统一域名。同时给出 PM2 进程管理建议与基础安全配置（环境变量保护、数据库连接安全）。

## 项目结构
- 后端采用 Node.js + Express + Prisma，提供统一前缀为 `/api/v1/` 的 REST 接口，数据库已从 SQLite 迁移至 PostgreSQL。
- 前端采用 Vue3 + TypeScript + Vite，构建产物默认输出至 dist 目录。
- 部署支持本地服务器与 Vercel 云平台两种方式，通过 `vercel.json` 和 `deploy-prepare.sh` 实现自动化准备。

```mermaid
graph TB
subgraph "前端"
FE_PKG["frontend/package.json<br/>脚本: build/preview/vercel-build"]
FE_VITE["frontend/vite.config.ts<br/>插件与别名"]
FE_HTML["frontend/index.html"]
FE_ENV["frontend/.env.production<br/>VITE_API_BASE_URL"]
end
subgraph "后端"
BE_PKG["backend/package.json<br/>脚本: start/build/vercel-build"]
BE_INDEX["backend/src/index.ts<br/>Express 服务与路由"]
BE_PRISMA_CFG["backend/prisma.config.ts<br/>Prisma 配置"]
BE_SCHEMA["backend/prisma/schema.prisma<br/>PostgreSQL 数据模型"]
BE_LOCK["backend/prisma/migrations/migration_lock.toml<br/>PostgreSQL 提供者"]
end
subgraph "部署"
VERCEL["vercel.json<br/>部署配置"]
SCRIPT["deploy-prepare.sh<br/>自动化准备脚本"]
end
FE_PKG --> |"构建产物"| FE_DIST["dist/"]
FE_DIST --> |"静态托管"| NGINX["Nginx/Vite 静态服务器"]
NGINX --> |"反向代理/静态资源"| BE_INDEX
BE_INDEX --> |"读取/写入"| DB["远程 PostgreSQL 数据库"]
VERCEL --> |"部署指令"| SCRIPT
SCRIPT --> |"准备构建环境"| FE_DIST
SCRIPT --> |"准备 API 环境"| API["api/"]
```

**图表来源**
- [frontend/package.json](file://frontend/package.json#L1-L54) - *添加 vercel-build 脚本*
- [backend/package.json](file://backend/package.json#L1-L37) - *添加 vercel-build 脚本*
- [frontend/vite.config.ts](file://frontend/vite.config.ts#L1-L19)
- [frontend/.env.production](file://frontend/.env.production#L1-L1) - *生产环境 API 基地址*
- [backend/prisma.config.ts](file://backend/prisma.config.ts#L1-L13) - *Prisma 配置*
- [backend/prisma/schema.prisma](file://backend/prisma/schema.prisma#L1-L19) - *PostgreSQL 数据模型*
- [backend/prisma/migrations/migration_lock.toml](file://backend/prisma/migrations/migration_lock.toml#L1-L3) - *PostgreSQL 提供者锁定*
- [vercel.json](file://vercel.json#L1-L13) - *Vercel 部署配置*
- [deploy-prepare.sh](file://deploy-prepare.sh#L1-L94) - *自动化部署脚本*

**章节来源**
- [DEPLOY.md](file://DEPLOY.md#L1-L260) - *Vercel 部署指南*
- [README.md](file://README.md#L162-L263) - *部署说明*

## 核心组件
- 前端构建与运行
  - 使用 Vite 构建，脚本定义了 build、preview 和 vercel-build 等命令，适合生产打包与云部署。
  - 构建产物默认输出至 dist 目录，可通过 Nginx 或 Vite 静态服务器托管。
  - 生产环境通过 `.env.production` 配置 `VITE_API_BASE_URL=/api/v1` 指定 API 基地址。
- 后端服务与数据库
  - Express 应用监听端口，提供 `/api/v1/` 前缀的接口。
  - Prisma 通过 `prisma.config.ts` 读取 `PRISMA_DATABASE_URL` 环境变量，连接远程 PostgreSQL 数据库。
  - 数据模型定义在 `schema.prisma` 中，迁移锁文件确保使用 PostgreSQL 提供者。
- 部署自动化
  - `vercel.json` 定义构建命令、输出目录和重写规则，实现前后端一体化部署。
  - `deploy-prepare.sh` 脚本自动化完成依赖安装、代码编译、环境变量配置等准备工作。

**章节来源**
- [frontend/package.json](file://frontend/package.json#L1-L54)
- [frontend/.env.production](file://frontend/.env.production#L1-L1)
- [backend/src/index.ts](file://backend/src/index.ts#L1-L373)
- [backend/prisma.config.ts](file://backend/prisma.config.ts#L1-L13)
- [backend/prisma/schema.prisma](file://backend/prisma/schema.prisma#L1-L19)
- [vercel.json](file://vercel.json#L1-L13)
- [deploy-prepare.sh](file://deploy-prepare.sh#L1-L94)

## 架构总览
生产部署推荐两种路径：
- 方案一：Vercel 云部署（推荐）
  - 使用 `vercel.json` 配置一体化构建流程，前端构建产物输出到 `frontend/dist`，后端编译代码部署为 Serverless Function。
  - 通过重写规则将 `/api/v1/*` 请求代理到后端服务。
- 方案二：自托管服务器
  - 前端通过 Nginx 或 Vite 静态服务器对外提供页面；后端独立运行，通过反向代理将 `/api/v1/` 请求转发到后端服务。

```mermaid
graph TB
subgraph "生产环境"
subgraph "前端层"
FE_NGINX["Nginx/Vite 静态服务器"]
FE_DIST["dist/ 静态资源"]
end
subgraph "后端层"
BE_EXPRESS["Express 服务"]
BE_PRISMA["Prisma 数据源"]
DB["远程 PostgreSQL 数据库"]
end
FE_NGINX --> |"静态资源"| FE_DIST
FE_NGINX --> |"反向代理 /api/v1/"| BE_EXPRESS
BE_EXPRESS --> BE_PRISMA --> DB
end
```

**图表来源**
- [frontend/package.json](file://frontend/package.json#L1-L54)
- [backend/src/index.ts](file://backend/src/index.ts#L1-L373)
- [backend/prisma.config.ts](file://backend/prisma.config.ts#L1-L13)
- [vercel.json](file://vercel.json#L1-L13)

## 详细组件分析

### 前端构建与部署
- 构建流程
  - 使用 `npm run build` 生成 dist 目录静态文件。
  - 可选：使用 `npm run preview` 在本地预览构建效果。
  - Vercel 部署使用 `vercel-build` 脚本，自动执行构建流程。
- 静态托管
  - 方案 A：将 dist 直接作为后端静态资源目录，统一域名，避免跨域问题。
  - 方案 B：使用 Nginx 或 Vite 静态服务器对外提供页面，后端通过反向代理处理 `/api/v1/` 请求。
  - 方案 C（推荐）：通过 Vercel 部署，`vercel.json` 指定 `outputDirectory: "frontend/dist"`。
- 路由与入口
  - index.html 中挂载根节点，入口脚本位于 src/main.ts，构建后由 Vite 打包到 dist。
- 环境变量
  - 生产环境使用 `.env.production` 配置 `VITE_API_BASE_URL=/api/v1`，确保 API 请求正确路由。

**章节来源**
- [frontend/package.json](file://frontend/package.json#L1-L54)
- [frontend/vite.config.ts](file://frontend/vite.config.ts#L1-L19)
- [frontend/index.html](file://frontend/index.html#L1-L14)
- [frontend/.env.production](file://frontend/.env.production#L1-L1)

### 后端服务与数据库
- 服务启动
  - 使用 `npm start` 启动 Express 应用，默认监听端口由环境变量控制。
  - Vercel 部署使用 `npm run vercel-build` 编译代码。
- 接口约定
  - 所有接口以 `/api/v1/` 为前缀，便于反向代理与统一管理。
- 数据库配置
  - `PRISMA_DATABASE_URL` 通过环境变量传入，Prisma 从 `prisma.config.ts` 读取该值。
  - 数据库已从 SQLite 迁移至 PostgreSQL，`schema.prisma` 中 `provider = "postgresql"`。
  - 生产环境必须配置远程 PostgreSQL 数据库连接字符串，格式为 `postgres://user:pass@host:port/db?sslmode=require`。
- 初始化与迁移
  - 使用 `npx prisma migrate deploy` 在生产环境应用数据库迁移。
  - 种子脚本可用于初始化示例数据。

```mermaid
sequenceDiagram
participant Client as "浏览器"
participant FE as "前端静态服务器(Nginx/Vite)"
participant BE as "后端 Express"
participant PRISMA as "Prisma"
participant DB as "远程 PostgreSQL 数据库"
Client->>FE : 访问页面
Client->>FE : 发起 /api/v1/game/random-char
FE->>BE : 反向代理转发请求
BE->>PRISMA : 查询诗词数据
PRISMA->>DB : 读取/写入
DB-->>PRISMA : 返回结果
PRISMA-->>BE : 结果
BE-->>FE : JSON 响应
FE-->>Client : 前端渲染
```

**图表来源**
- [backend/src/index.ts](file://backend/src/index.ts#L1-L373)
- [backend/prisma.config.ts](file://backend/prisma.config.ts#L1-L13)
- [backend/prisma/schema.prisma](file://backend/prisma/schema.prisma#L1-L19)
- [backend/.env](file://backend/.env) - *环境变量配置*

**章节来源**
- [backend/src/index.ts](file://backend/src/index.ts#L1-L373)
- [backend/prisma.config.ts](file://backend/prisma.config.ts#L1-L13)
- [backend/prisma/schema.prisma](file://backend/prisma/schema.prisma#L1-L19)
- [DEPLOY.md](file://DEPLOY.md#L1-L260)

### 数据模型与迁移
- Poem 表包含主键、标题、作者、内容等字段，用于存储诗词数据。
- 新增 `dynasty` 字段（可为空），保持向后兼容。
- 初始迁移文件定义了表结构，生产部署时需确保迁移已执行。
- 使用 PostgreSQL 作为生产数据库，提供更好的并发性能和数据完整性。

```mermaid
erDiagram
POEM {
integer id PK
text title
text author
text content
text dynasty
}
```

**图表来源**
- [backend/prisma/schema.prisma](file://backend/prisma/schema.prisma#L1-L19)

**章节来源**
- [backend/prisma/schema.prisma](file://backend/prisma/schema.prisma#L1-L19)

### Vercel 部署配置
- `vercel.json` 配置文件定义了：
  - `buildCommand`: 构建命令，依次安装前后端依赖并构建。
  - `outputDirectory`: 前端构建产物目录 `frontend/dist`。
  - `rewrites`: 将 `/api/v1/*` 请求重写到后端 Serverless Function。
- 自动化脚本 `deploy-prepare.sh` 完成以下任务：
  - 安装后端依赖并生成 Prisma Client
  - 编译后端代码到 `dist` 目录
  - 同步编译结果到 `api/` 目录供 Vercel 使用
  - 创建前端生产环境变量文件
  - 安装前端依赖并测试构建

**章节来源**
- [vercel.json](file://vercel.json#L1-L13)
- [deploy-prepare.sh](file://deploy-prepare.sh#L1-L94)
- [DEPLOY.md](file://DEPLOY.md#L1-L260)

## 依赖关系分析
- 前端依赖
  - Vue3、Vue Router、Pinia、Vite 插件等，构建脚本由 package.json 定义。
- 后端依赖
  - Express、Prisma、@prisma/client、cors、pinyin-pro、fastest-levenshtein 等。
  - 移除了 sqlite3 依赖，转而使用 PostgreSQL 驱动。
- 关键配置
  - `PRISMA_DATABASE_URL` 通过环境变量注入，Prisma 从 `prisma.config.ts` 读取。
  - Express 应用提供 `/api/v1/*` 接口。
  - Vercel 部署依赖 `vercel.json` 和自动化脚本。

```mermaid
graph LR
FE_PKG["frontend/package.json"] --> FE_DEPS["Vue3/Vite/TS 依赖"]
BE_PKG["backend/package.json"] --> BE_DEPS["Express/Prisma/TS 依赖"]
BE_ENV[".env(PRISMA_DATABASE_URL)"] --> PRISMA_CFG["prisma.config.ts"]
PRISMA_CFG --> PRISMA_DB["远程 PostgreSQL 数据库"]
BE_INDEX["backend/src/index.ts"] --> API["/api/v1/* 接口"]
VERCEL_CFG["vercel.json"] --> DEPLOY["Vercel 部署流程"]
SCRIPT["deploy-prepare.sh"] --> PREPARE["部署准备"]
```

**图表来源**
- [frontend/package.json](file://frontend/package.json#L1-L54)
- [backend/package.json](file://backend/package.json#L1-L37)
- [backend/prisma.config.ts](file://backend/prisma.config.ts#L1-L13)
- [backend/src/index.ts](file://backend/src/index.ts#L1-L373)
- [vercel.json](file://vercel.json#L1-L13)
- [deploy-prepare.sh](file://deploy-prepare.sh#L1-L94)

**章节来源**
- [backend/package.json](file://backend/package.json#L1-L37)
- [backend/prisma.config.ts](file://backend/prisma.config.ts#L1-L13)
- [vercel.json](file://vercel.json#L1-L13)
- [deploy-prepare.sh](file://deploy-prepare.sh#L1-L94)

## 性能与稳定性建议
- 静态资源优化
  - 前端构建启用压缩与缓存策略，结合 CDN 加速（Vercel 默认提供）。
- 反向代理与负载均衡
  - 使用 Nginx 或反向代理统一域名，将 `/api/v1/` 转发到后端服务，减少跨域与证书复杂度。
  - Vercel 自动提供边缘网络和负载均衡。
- 进程管理
  - 自托管时使用 PM2 管理后端进程，支持自动重启、日志聚合与健康检查。
  - Vercel 使用 Serverless 架构，无需手动管理进程。
- 数据库与连接
  - 生产环境使用 PostgreSQL，配置连接池和 SSL 加密。
  - 设置合理的超时和重试机制。
- 端口与网络
  - 后端监听端口由环境变量控制，确保防火墙放行对应端口。
  - Vercel 自动处理网络配置。

[本节为通用建议，无需特定文件引用]

## 故障排查指南
- 接口 404/400
  - 确认前端是否正确调用 `/api/v1/` 前缀接口，后端路由是否按约定实现。
  - 检查 `vercel.json` 重写规则是否正确。
- 数据库连接失败
  - 检查 `PRISMA_DATABASE_URL` 是否正确指向 PostgreSQL 数据库，确认环境变量已生效。
  - 确保数据库允许远程连接并配置 SSL。
- 构建产物未生效
  - 确认 `dist` 目录已部署到静态服务器或后端静态资源目录，路径与 Nginx/Vite 配置一致。
  - 检查 `vercel.json` 的 `outputDirectory` 是否正确。
- CORS 问题
  - 后端已启用 CORS 中间件，若仍出现跨域，请检查反向代理与域名配置。
- Vercel 部署失败
  - 查看构建日志，常见问题包括依赖版本冲突、Node.js 版本不匹配、环境变量缺失。
  - 确保 `deploy-prepare.sh` 脚本执行成功。

**章节来源**
- [backend/src/index.ts](file://backend/src/index.ts#L1-L373)
- [backend/prisma.config.ts](file://backend/prisma.config.ts#L1-L13)
- [vercel.json](file://vercel.json#L1-L13)
- [DEPLOY.md](file://DEPLOY.md#L1-L260)

## 结论
本指南提供了前后端分离的生产部署路径与关键配置要点。前端通过 `npm run build` 生成静态产物，后端通过 `npm start` 启动服务并使用 Prisma 连接生产级 PostgreSQL 数据库。重点更新了从 SQLite 到 PostgreSQL 的迁移步骤，新增 Vercel 云平台的一键部署方案和 `deploy-prepare.sh` 自动化脚本说明。推荐使用 Vercel 部署以简化运维，或通过反向代理统一域名自托管，配合 PM2 实现进程管理与基础安全配置，确保系统稳定运行。

[本节为总结性内容，无需特定文件引用]

## 附录
- 前端构建命令
  - `npm run build`
  - `npm run preview`
- 后端启动命令
  - `npm start`
- 数据库配置
  - 在环境变量中设置 `PRISMA_DATABASE_URL`，指向 PostgreSQL 数据库，格式：`postgres://user:pass@host:port/db?sslmode=require`
- 项目约定
  - API 路由统一前缀 `/api/v1/`，便于部署与代理。
  - 使用 `vercel.json` 进行云部署配置
  - 通过 `deploy-prepare.sh` 自动化部署准备

**章节来源**
- [frontend/package.json](file://frontend/package.json#L1-L54)
- [backend/package.json](file://backend/package.json#L1-L37)
- [backend/prisma.config.ts](file://backend/prisma.config.ts#L1-L13)
- [vercel.json](file://vercel.json#L1-L13)
- [deploy-prepare.sh](file://deploy-prepare.sh#L1-L94)
- [DEPLOY.md](file://DEPLOY.md#L1-L260)