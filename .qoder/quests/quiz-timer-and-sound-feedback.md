# 诗词对战游戏增强功能设计文档

## 一、需求概述

本次功能增强旨在提升诗词对战游戏的互动性和趣味性，主要面向儿童用户，通过增加时间限制、模糊匹配、音效反馈和分享功能，提升游戏体验的紧张感、包容性和成就感。

### 核心需求

1. **答题时间限制**：每题设置10秒倒计时，超时视为失败
2. **模糊匹配验证**：支持语音输入场景下的错别字和同音字容错
3. **音效反馈系统**：根据不同游戏状态播放相应的音效
4. **结算卡片分享**：结算页面支持保存为图片并分享
5. **儿童友好设计**：结算页面采用鼓励性设计风格

---

## 二、功能详细设计

### 2.1 答题倒计时功能

#### 2.1.1 业务目标

增加游戏紧张感和挑战性，培养孩子快速思考和反应能力。

#### 2.1.2 功能规则

| 规则项 | 说明 |
|--------|------|
| 倒计时时长 | 每题固定10秒 |
| 计时起点 | AI出句完成后立即开始计时 |
| 计时终点 | 用户提交答案或倒计时归零 |
| 超时处理 | 扣除一次答题机会，触发失败音效，若机会耗尽则结束游戏 |
| 重置时机 | 每次答对后重置为10秒，进入下一轮 |
| 暂停机制 | 点击提示按钮时暂停倒计时，显示提示后恢复 |

#### 2.1.3 状态数据结构扩展

需要在游戏状态中新增如下字段：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| timeRemaining | number | 当前剩余时间（秒） |
| timerActive | boolean | 计时器是否激活 |
| roundStartTime | number | 当前回合开始时间戳 |

#### 2.1.4 UI展示规则

| 时间范围 | 视觉效果 |
|----------|----------|
| 10-6秒 | 绿色显示，平稳动画 |
| 5-3秒 | 黄色显示，加速跳动动画 |
| 2-0秒 | 红色显示，快速闪烁动画 |

---

### 2.2 模糊匹配验证功能

#### 2.2.1 业务目标

支持语音输入场景，降低输入错误导致的挫败感，提升儿童用户的容错体验。

#### 2.2.2 匹配规则

支持两种匹配策略：

**策略一：同音字匹配**
- 将用户输入的文字转换为拼音
- 与诗词库中的诗句进行拼音级别的对比
- 允许声调差异（如 má 和 mā 视为匹配）

**策略二：字符级模糊匹配**
- 计算用户输入与标准诗句的编辑距离
- 允许最多1个字符差异（替换、插入或删除）

#### 2.2.3 验证流程

```
用户输入诗句
    ↓
移除标点符号和空格
    ↓
优先精确匹配
    ↓ (未匹配)
同音字匹配
    ↓ (未匹配)
编辑距离匹配
    ↓
返回验证结果
```

#### 2.2.4 API响应扩展

验证接口需要返回额外信息：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| matchType | string | 匹配类型：exact（精确）、homophone（同音）、fuzzy（模糊） |
| correctedSentence | string | 如果是模糊匹配，返回正确的诗句 |
| differences | array | 不一致的字符位置和内容 |

#### 2.2.5 后端实现策略

**拼音转换库选择**
- 使用 pinyin-pro 库进行汉字到拼音转换
- 配置为无声调模式以提升匹配宽容度

**匹配算法**
- 精确匹配：直接字符串比对
- 同音匹配：逐字拼音比对
- 模糊匹配：使用 Levenshtein 距离算法，阈值设为1

**性能优化**
- 对诗词库进行拼音索引预处理
- 缓存常用诗句的拼音映射

---

### 2.3 音效反馈系统

#### 2.3.1 音效资源规划

| 场景 | 音效类型 | 时长 | 音调特征 | 触发时机 |
|------|----------|------|----------|----------|
| 答对 | 欢快音效 | 1-2秒 | 明快上扬，C大调 | 诗句验证通过时 |
| 单次答错 | 简短失败音 | 0.5-1秒 | 低沉短促，A小调 | 诗句验证失败且仍有机会时 |
| 游戏失败 | 长失败音 | 2-3秒 | 渐弱悲伤，弦乐音色 | 机会耗尽或超时失败时 |
| 结算 | 欢乐结算音 | 3-4秒 | 庆祝氛围，管弦乐 | 进入结算页面时 |
| 倒计时警告 | 滴答音 | 0.3秒 | 尖锐提示音 | 剩余3秒及以下时，每秒一次 |

#### 2.3.2 音频文件规范

| 规范项 | 要求 |
|--------|------|
| 格式 | MP3 或 OGG（浏览器兼容性） |
| 采样率 | 44.1kHz |
| 比特率 | 128kbps |
| 音量 | 标准化到 -3dB |
| 存储路径 | frontend/src/assets/sounds/ |

#### 2.3.3 音效管理服务设计

音效服务需提供以下功能：

| 功能方法 | 参数 | 说明 |
|----------|------|------|
| preloadSounds | soundList | 预加载所有音效文件 |
| playSound | soundName, volume | 播放指定音效，支持音量调节 |
| stopSound | soundName | 停止指定音效 |
| setGlobalVolume | volume | 设置全局音量 |
| toggleMute | - | 静音开关 |

#### 2.3.4 用户控制设置

在游戏设置中提供：
- 音效开关（默认开启）
- 音量调节滑块（0-100%，默认80%）
- 设置持久化到本地存储

---

### 2.4 结算卡片分享功能

#### 2.4.1 业务目标

增强游戏社交属性和成就感，鼓励儿童分享学习成果。

#### 2.4.2 卡片内容设计

**视觉层次结构**

| 层级 | 内容 | 设计要点 |
|------|------|----------|
| 顶部装饰区 | 勋章图标、等级称号 | 大尺寸、醒目颜色、动态感 |
| 主信息区 | 关键字、答对数、总回合数 | 中国风字体、金色强调 |
| 统计数据区 | 正确率、用时、使用提示 | 图表化展示、色彩编码 |
| 激励语区 | 根据成绩生成的鼓励语 | 温暖色调、友好措辞 |
| 底部品牌区 | 应用名称、二维码 | 低调呈现 |

**等级称号体系**

| 答对数 | 称号 | 勋章图案 |
|--------|------|----------|
| 10+ | 诗词小状元 | 金色状元帽 |
| 7-9 | 诗词小秀才 | 银色书卷 |
| 5-6 | 诗词小童生 | 铜色印章 |
| 3-4 | 诗词小学徒 | 青色竹简 |
| 0-2 | 诗词小萌新 | 粉色花朵 |

#### 2.4.3 图片生成方案

**技术选型：html2canvas**

渲染流程：
1. 创建专用的卡片DOM结构（与页面显示分离）
2. 应用CSS样式确保固定尺寸（750px × 1200px）
3. 调用html2canvas生成canvas
4. 转换为PNG格式的Blob对象
5. 触发下载或提供分享选项

**性能优化策略**
- 预渲染卡片结构，隐藏在视口外
- 图片资源使用内联Base64减少网络请求
- 渲染完成后清理临时DOM

#### 2.4.4 分享功能设计

**分享渠道**

| 渠道 | 实现方式 | 优先级 |
|------|----------|--------|
| 保存到相册 | 触发浏览器下载 | P0 |
| 复制到剪贴板 | Clipboard API | P1 |
| 系统分享 | Web Share API（移动端） | P1 |
| 社交平台分享 | 第三方SDK（可选） | P2 |

**交互流程**

```
点击分享按钮
    ↓
显示加载动画
    ↓
生成卡片图片
    ↓
弹出分享选项菜单
    ├─ 保存图片
    ├─ 复制图片
    └─ 分享到...
    ↓
执行对应操作
    ↓
显示成功提示
```

---

### 2.5 儿童友好结算页面设计

#### 2.5.1 设计原则

| 原则 | 具体实施 |
|------|----------|
| 正向激励 | 任何成绩都给予肯定和鼓励 |
| 视觉愉悦 | 明亮色彩、可爱插图、动画效果 |
| 成就感 | 突出进步和亮点 |
| 简洁易懂 | 图标化信息、减少文字 |

#### 2.5.2 色彩方案

| 元素 | 颜色 | 色值参考 |
|------|------|----------|
| 背景渐变 | 浅粉到浅黄 | #FFF5F7 → #FFF9E6 |
| 主色调 | 温暖金色 | #FFD700 |
| 强调色 | 活力橙色 | #FF9500 |
| 文字主色 | 深灰蓝 | #2C3E50 |
| 成功绿 | 清新绿 | #5FD381 |

#### 2.5.3 动画效果设计

| 元素 | 动画类型 | 时长 | 效果描述 |
|------|----------|------|----------|
| 勋章 | 缩放弹跳 | 0.6秒 | 从小到大弹出，带回弹效果 |
| 称号文字 | 淡入上浮 | 0.8秒 | 透明度0到1，同时向上移动20px |
| 统计数字 | 数字滚动 | 1秒 | 从0滚动到目标数值 |
| 星星装饰 | 闪烁旋转 | 循环 | 随机位置的小星星闪烁 |
| 整体入场 | 阶梯渐显 | 1.5秒 | 各区块依次从下到上淡入 |

#### 2.5.4 激励文案策略

根据答对数和表现生成个性化鼓励语：

**高分段（7+题正确）**
- "太棒了！你是诗词小天才！"
- "惊艳表现！爸爸妈妈一定为你骄傲！"

**中分段（4-6题正确）**
- "很不错哦！继续加油就能成为高手！"
- "进步很大！下次一定能答对更多！"

**低分段（1-3题正确）**
- "好的开始！熟能生巧，多练习就会更厉害！"
- "每一次尝试都是进步！继续努力！"

**特殊鼓励（使用提示较多）**
- "善于学习也是一种智慧！"
- "会思考的孩子最聪明！"

---

## 三、技术实现要点

### 3.1 前端状态管理扩展

#### 游戏状态新增字段

在 GameState 类型中需要扩展：

| 字段名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| timeRemaining | number | 10 | 当前倒计时剩余秒数 |
| timerActive | boolean | false | 计时器是否运行中 |
| roundStartTime | number | 0 | 当前回合开始的时间戳 |
| soundEnabled | boolean | true | 音效是否启用 |
| soundVolume | number | 0.8 | 音效音量（0-1） |

#### 计时器管理逻辑

**启动计时器时机**
- AI出句完成后
- 提示显示完成后（如果使用了提示）

**停止计时器时机**
- 用户提交答案
- 点击提示按钮
- 倒计时归零
- 游戏结束

**倒计时状态同步**
- 使用 setInterval 每100ms更新一次显示
- 使用响应式变量触发UI更新
- 保证时间精确性，使用时间戳计算而非累加

### 3.2 后端验证逻辑改造

#### 验证流程扩展

原有验证流程基础上增加模糊匹配步骤：

1. 参数验证（诗句、令字、已用诗句列表）
2. 令字包含性检查
3. 重复性检查
4. **精确匹配查询**（现有逻辑）
5. **同音字匹配查询**（新增）
6. **编辑距离匹配查询**（新增）
7. 返回验证结果及匹配详情

#### API接口调整

verify接口响应结构扩展：

| 字段 | 类型 | 说明 |
|------|------|------|
| valid | boolean | 是否通过验证 |
| matchType | string | 匹配类型 |
| message | string | 验证消息 |
| poem | object | 原有诗词信息 |
| correctedSentence | string | 标准诗句（模糊匹配时） |
| differences | array | 差异字符信息 |

### 3.3 音效服务实现

#### 服务架构

创建独立的音效管理服务模块，提供：

- 音效资源预加载
- 播放控制（播放、暂停、停止）
- 音量管理
- 状态持久化

#### 浏览器兼容性处理

- 优先使用 Web Audio API
- 降级方案：HTML5 Audio标签
- 自动播放限制应对：用户首次交互后初始化

### 3.4 图片生成实现

#### 依赖库

| 库名 | 版本 | 用途 |
|------|------|------|
| html2canvas | ^1.4.1 | DOM到Canvas转换 |

#### 生成配置

| 配置项 | 值 | 说明 |
|--------|----|----|
| scale | 2 | 分辨率倍数，提升清晰度 |
| backgroundColor | #ffffff | 背景色 |
| useCORS | true | 允许跨域图片 |
| width | 750 | 固定宽度 |
| height | 1200 | 固定高度 |

---

## 四、用户体验流程

### 4.1 完整游戏流程（含新功能）

```
开始游戏
    ↓
选择关键字
    ↓
AI出首句 → 播放欢快音效
    ↓
倒计时开始（10秒）
    ↓
    ├─ 用户输入诗句
    │   ↓
    │   提交答案
    │   ↓
    │   验证（精确/同音/模糊）
    │   ↓
    │   ├─ 答对 → 播放欢快音效 → AI出句 → 重置倒计时
    │   └─ 答错 → 播放失败音 → 扣除机会
    │       ↓
    │       ├─ 仍有机会 → 继续当前回合
    │       └─ 机会耗尽 → 播放长失败音 → 结算页面
    │
    ├─ 点击提示 → 暂停倒计时 → 显示提示 → 恢复倒计时
    │
    └─ 倒计时归零 → 播放长失败音 → 扣除机会 → 判断是否结束
    
结算页面
    ↓
播放欢乐结算音 + 动画展示
    ↓
显示成绩卡片
    ↓
点击分享 → 生成图片 → 保存/分享
```

### 4.2 超时失败流程

```
倒计时归零
    ↓
停止用户输入
    ↓
播放长失败音效
    ↓
扣除一次机会
    ↓
显示"超时了！"提示（2秒）
    ↓
判断剩余机会
    ├─ 仍有机会 → 重置倒计时 → 继续当前回合
    └─ 机会耗尽 → 跳转结算页面
```

### 4.3 模糊匹配反馈流程

```
用户提交诗句
    ↓
后端验证
    ↓
模糊匹配成功
    ↓
播放欢快音效
    ↓
显示提示消息
    ├─ "虽然有个小错字，但意思对了！"
    ├─ 标准诗句：XXXX
    └─ 你的输入：XXXX（差异字标红）
    ↓
等待1.5秒
    ↓
继续游戏流程
```

---

## 五、数据统计扩展

### 5.1 新增统计指标

在游戏统计中增加以下维度：

| 指标名 | 类型 | 说明 |
|--------|------|------|
| timeoutCount | number | 超时次数 |
| fuzzyMatchCount | number | 模糊匹配次数 |
| averageResponseTime | number | 平均答题时间（秒） |
| fastestResponse | number | 最快答题时间（秒） |
| perfectRounds | number | 完美回合数（无提示、无错误） |

### 5.2 结算页展示优化

根据新增统计数据，结算页面可展示：

- 反应速度评价（基于平均答题时间）
- 稳定性评价（基于超时和错误次数）
- 特殊成就徽章（如"闪电回答"、"完美通关"）

---

## 六、风险与应对

### 6.1 技术风险

| 风险项 | 影响 | 应对措施 |
|--------|------|----------|
| 拼音库准确性问题 | 同音字匹配误判 | 选用成熟的pinyin-pro库，进行充分测试 |
| 浏览器自动播放限制 | 音效无法播放 | 引导用户首次交互，降级静音提示 |
| html2canvas跨域图片 | 卡片生成失败 | 图片资源同域部署或使用Base64内联 |
| 移动端性能问题 | 倒计时卡顿 | 使用requestAnimationFrame优化动画 |

### 6.2 用户体验风险

| 风险项 | 影响 | 应对措施 |
|--------|------|----------|
| 10秒时间过短 | 儿童用户压力过大 | 提供难度设置选项（未来迭代） |
| 模糊匹配过于宽松 | 降低学习价值 | 限制只允许1个字差异，并给出正确提示 |
| 音效过于频繁 | 用户厌烦 | 提供音效开关和音量调节 |
| 分享图片质量差 | 影响分享意愿 | 使用2倍分辨率渲染，优化布局 |

---

## 七、开发检查清单

### 7.1 前端开发任务

- [ ] 游戏状态扩展（倒计时相关字段）
- [ ] 倒计时组件开发（包含视觉效果）
- [ ] 倒计时逻辑集成（启动、暂停、重置）
- [ ] 音效服务模块开发
- [ ] 音效资源准备与集成
- [ ] 音效播放时机埋点
- [ ] 用户音效设置界面
- [ ] 结算页面重构（儿童友好设计）
- [ ] 结算卡片组件开发
- [ ] html2canvas集成与图片生成
- [ ] 分享功能实现（下载、复制、系统分享）
- [ ] 动画效果实现
- [ ] 模糊匹配结果UI提示

### 7.2 后端开发任务

- [ ] 安装并配置 pinyin-pro 库
- [ ] 编辑距离算法实现或库引入
- [ ] verify接口改造（模糊匹配逻辑）
- [ ] 诗词拼音索引预处理脚本
- [ ] API响应结构扩展
- [ ] 单元测试（精确匹配、同音匹配、编辑距离匹配）
- [ ] 性能测试与优化

### 7.3 资源准备任务

- [ ] 音效文件制作或采购（5个场景）
- [ ] 音效格式转换与优化
- [ ] 勋章图标设计（5个等级）
- [ ] 结算页装饰元素设计（星星、花纹等）
- [ ] 字体资源确认（中国风字体）

### 7.4 测试验证任务

- [ ] 倒计时精确度测试
- [ ] 超时触发逻辑测试
- [ ] 同音字匹配准确性测试（准备测试用例）
- [ ] 错别字容错测试（准备测试用例）
- [ ] 音效播放兼容性测试（Chrome、Safari、移动端）
- [ ] 图片生成质量测试（清晰度、布局）
- [ ] 分享功能测试（各渠道可用性）
- [ ] 结算页动画流畅性测试
- [ ] 儿童用户实际体验测试

---

## 八、后续优化方向

### 8.1 功能增强

- 难度分级（调整倒计时时长：简单15秒、普通10秒、困难5秒）
- 成就系统（收集勋章、解锁称号）
- 历史成绩记录与趋势分析
- 多人对战模式
- 语音输入直接集成

### 8.2 体验优化

- 自适应倒计时（根据诗句难度调整时间）
- 更丰富的音效库和音乐背景
- 3D动画效果
- AR分享卡片
- 家长端成绩报告

---

## 附录：技术依赖清单

### 前端新增依赖

| 依赖包 | 版本 | 用途 |
|--------|------|------|
| html2canvas | ^1.4.1 | 生成分享卡片图片 |

### 后端新增依赖

| 依赖包 | 版本 | 用途 |
|--------|------|------|
| pinyin-pro | ^3.19.0 | 汉字转拼音 |
| fastest-levenshtein | ^1.0.16 | 计算编辑距离 |
