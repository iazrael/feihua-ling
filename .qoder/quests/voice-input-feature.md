# 语音输入功能设计文档

## 1. 概述

### 1.1 目标
为飞花令游戏添加语音输入功能，提升用户体验，特别是对儿童用户更加友好。用户可以通过按住按钮说话的方式输入诗句，系统自动将语音转换为文本并提交验证。

### 1.2 范围
本设计涵盖前端语音录制、语音识别服务集成、文本容错处理以及麦克风权限申请等模块。

## 2. 需求分析

### 2.1 功能需求
1. **语音录制**: 用户按住按钮开始录音，松开按钮结束录音
2. **语音识别**: 将录制的语音发送至腾讯云ASR服务进行识别
3. **文本提交**: 自动将识别结果提交至游戏验证接口
4. **容错处理**: 对识别结果进行多音字、前鼻音后鼻音等容错处理
5. **权限申请**: 页面加载时申请麦克风权限并提供友好说明

### 2.2 非功能需求
1. **用户体验**: 录音过程应有明确的视觉反馈
2. **兼容性**: 需要考虑浏览器兼容性问题
3. **性能**: 语音识别响应时间应尽可能短

## 3. 技术方案

### 3.1 前端实现
1. **录音接口**: 使用浏览器原生的`MediaRecorder` API进行录音
2. **权限申请**: 使用`navigator.mediaDevices.getUserMedia`申请麦克风权限
3. **腾讯云ASR集成**: 使用腾讯云提供的JavaScript SDK进行语音识别
4. **UI组件**: 在InputPanel组件中添加录音按钮和权限申请提示

### 3.2 后端实现
1. **现有验证逻辑**: 复用现有的诗句验证逻辑，包括同音字和编辑距离匹配
2. **容错处理**: 利用已有的`pinyin-pro`和`fastest-levenshtein`库进行文本容错处理

## 4. 详细设计

### 4.1 前端设计

#### 4.1.1 InputPanel组件更新
1. 添加录音按钮，支持按下开始录音，松开结束录音
2. 添加录音状态指示器（视觉反馈）
3. 添加麦克风权限申请逻辑和提示信息

#### 4.1.2 录音服务模块
1. 创建新的录音服务模块，负责：
   - 麦克风权限申请
   - 音频录制
   - 与腾讯云ASR SDK交互
   - 返回识别结果

#### 4.1.3 语音识别服务集成
1. 集成腾讯云语音识别JavaScript SDK
2. 实现音频数据上传和结果获取
3. 处理识别错误和网络异常

### 4.2 后端设计

#### 4.2.1 文本容错处理
1. 复用现有的同音字匹配逻辑（基于拼音）
2. 复用现有的编辑距离匹配逻辑（允许1个字符差异）
3. 保持现有API接口不变，仅优化匹配算法

## 5. 容错处理设计

### 5.1 多音字处理
1. 利用现有`pinyin-pro`库获取输入文本和诗词库中诗句的拼音
2. 比较拼音是否一致，实现同音字匹配

### 5.2 前鼻音后鼻音容错
1. 利用现有`fastest-levenshtein`库计算编辑距离
2. 当编辑距离为1时，认为是前鼻音后鼻音等小错误

### 5.3 其他容错机制
1. 标点符号和空格清理
2. 长度差异检查（限制在2个字符以内）

## 6. 权限申请设计

### 6.1 权限申请时机
1. 页面加载时自动申请麦克风权限

### 6.2 用户提示
1. 提供友好的权限申请说明文本
2. 在权限被拒绝时提供重新申请的入口

## 7. 错误处理

### 7.1 录音错误
1. 麦克风权限被拒绝
2. 浏览器不支持录音功能

### 7.2 识别错误
1. 网络连接问题
2. 识别服务异常
3. 识别结果为空

### 7.3 容错处理错误
1. 诗词库中未找到匹配诗句

## 8. 测试计划

### 8.1 功能测试
1. 录音功能测试（开始/结束）
2. 语音识别准确性测试
3. 文本提交流程测试
4. 容错处理测试（多音字、前鼻音后鼻音）

### 8.2 兼容性测试
1. 主流浏览器录音功能兼容性测试
2. 移动端浏览器兼容性测试

### 8.3 性能测试
1. 语音识别响应时间测试
2. 录音功能资源占用测试

## 9. 部署与维护

### 9.1 部署注意事项
1. 确保腾讯云ASR服务配置正确
2. 检查浏览器兼容性支持情况

### 9.2 维护计划
1. 监控语音识别服务的可用性
### 3.1 前端实现
1. **录音接口**: 使用浏览器原生的`MediaRecorder` API进行录音
2. **权限申请**: 使用`navigator.mediaDevices.getUserMedia`申请麦克风权限
3. **腾讯云ASR集成**: 使用腾讯云提供的JavaScript SDK进行语音识别
4. **UI组件**: 在InputPanel组件中添加录音按钮和权限申请提示

### 3.2 后端实现
1. **现有验证逻辑**: 复用现有的诗句验证逻辑，包括同音字和编辑距离匹配
2. **容错处理**: 利用已有的`pinyin-pro`和`fastest-levenshtein`库进行文本容错处理

## 4. 详细设计

### 4.1 前端设计

#### 4.1.1 InputPanel组件更新
1. 添加录音按钮，支持按下开始录音，松开结束录音
2. 添加录音状态指示器（视觉反馈）
3. 添加麦克风权限申请逻辑和提示信息

#### 4.1.2 录音服务模块
1. 创建新的录音服务模块，负责：
   - 麦克风权限申请
   - 音频录制
   - 与腾讯云ASR SDK交互
   - 返回识别结果

#### 4.1.3 语音识别服务集成
1. 集成腾讯云语音识别JavaScript SDK
2. 实现音频数据上传和结果获取
3. 处理识别错误和网络异常

### 4.2 后端设计

#### 4.2.1 文本容错处理
1. 复用现有的同音字匹配逻辑（基于拼音）
2. 复用现有的编辑距离匹配逻辑（允许1个字符差异）
3. 保持现有API接口不变，仅优化匹配算法

## 5. 容错处理设计

### 5.1 多音字处理
1. 利用现有`pinyin-pro`库获取输入文本和诗词库中诗句的拼音
2. 比较拼音是否一致，实现同音字匹配

### 5.2 前鼻音后鼻音容错
1. 利用现有`fastest-levenshtein`库计算编辑距离
2. 当编辑距离为1时，认为是前鼻音后鼻音等小错误

### 5.3 其他容错机制
1. 标点符号和空格清理
2. 长度差异检查（限制在2个字符以内）

## 6. 权限申请设计

### 6.1 权限申请时机
1. 页面加载时自动申请麦克风权限

### 6.2 用户提示
1. 提供友好的权限申请说明文本
2. 在权限被拒绝时提供重新申请的入口

## 7. 错误处理

### 7.1 录音错误
1. 麦克风权限被拒绝
2. 浏览器不支持录音功能

### 7.2 识别错误
1. 网络连接问题
2. 识别服务异常
3. 识别结果为空

### 7.3 容错处理错误
1. 诗词库中未找到匹配诗句

## 8. 测试计划

### 8.1 功能测试
1. 录音功能测试（开始/结束）
2. 语音识别准确性测试
3. 文本提交流程测试
4. 容错处理测试（多音字、前鼻音后鼻音）

### 8.2 兼容性测试
1. 主流浏览器录音功能兼容性测试
2. 移动端浏览器兼容性测试

### 8.3 性能测试
1. 语音识别响应时间测试
2. 录音功能资源占用测试

## 9. 部署与维护

### 9.1 部署注意事项
1. 确保腾讯云ASR服务配置正确
2. 检查浏览器兼容性支持情况

### 9.2 维护计划
1. 监控语音识别服务的可用性
2. 收集用户反馈，优化容错处理算法

## 3. 技术方案
