# 浏览器 Web Speech API 降级测试指南

## 测试目标

验证当腾讯云 ASR 不可用时，系统能够自动降级到浏览器内置的 Web Speech API，确保语音识别功能的可用性。

## 测试环境要求

### 支持的浏览器

| 浏览器 | 版本要求 | Web Speech API 支持 | 备注 |
|--------|---------|-------------------|------|
| Chrome | 25+ | ✅ 完整支持 | 推荐用于测试 |
| Edge | 79+ | ✅ 完整支持 | 基于 Chromium |
| Safari | 14.1+ | ⚠️ 部分支持 | 仅 macOS/iOS |
| Firefox | - | ❌ 不支持 | 不推荐测试 |
| Opera | 27+ | ✅ 完整支持 | 基于 Chromium |

### 操作系统

- **macOS**: 完整支持（系统内置语音识别）
- **Windows**: 完整支持（需启用语音识别）
- **Linux**: 有限支持（依赖浏览器）
- **Android**: Chrome 支持良好
- **iOS**: Safari 支持良好

## 前置准备

### 1. 启动前端服务

```bash
cd frontend
npm run dev
```

### 2. 授权麦克风权限

首次使用时，浏览器会请求麦克风权限，务必点击"允许"。

### 3. 测试环境

选择安静的环境进行测试，避免背景噪音影响识别准确率。

## 测试场景

### 测试 1: 浏览器支持检测

#### 1.1 在支持的浏览器中测试

1. 打开 Chrome 浏览器
2. 访问 `http://localhost:5173`
3. 打开浏览器控制台 Console
4. 输入以下代码：

```javascript
// 检测浏览器是否支持 Web Speech API
const supported = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
console.log('Web Speech API 支持:', supported);

// 获取浏览器信息
import { getBrowserSpeechInfo } from '@/services/browserSpeechService';
const info = getBrowserSpeechInfo();
console.log('浏览器信息:', info);
```

**预期输出：**
```javascript
{
  supported: true,
  browser: "Chrome",
  privacyNote: "Chrome 浏览器可能会将语音数据发送到 Google 服务器进行处理，请注意隐私保护。"
}
```

#### 1.2 在不支持的浏览器中测试

1. 打开 Firefox 浏览器
2. 重复上述步骤

**预期输出：**
```javascript
{
  supported: false,
  browser: "Unknown",
  privacyNote: "当前浏览器不支持 Web Speech API，建议使用 Chrome、Edge 或 Safari 浏览器。"
}
```

**预期 UI 行为：**
- ✅ "按住说话"按钮变为禁用状态
- ✅ 显示提示："您的浏览器不支持录音功能..."

### 测试 2: 手动触发浏览器识别

#### 2.1 直接调用浏览器识别

在 Chrome 浏览器控制台中：

```javascript
import { startBrowserRecognition } from '@/services/browserSpeechService';

// 开始识别
const result = await startBrowserRecognition();
console.log('识别结果:', result);
```

**操作步骤：**
1. 执行上述代码
2. 浏览器会提示使用麦克风
3. 说出"春眠不觉晓"
4. 等待识别完成

**预期输出：**
```
识别结果: 春眠不觉晓
```

### 测试 3: 自动降级测试

#### 3.1 模拟腾讯云 ASR 不可用

**方法 1: 断开后端连接**

```bash
# 停止后端服务
cd backend
# 按 Ctrl+C 停止
```

**方法 2: 删除环境变量**

编辑 `backend/.env`，临时注释掉腾讯云配置：

```env
# TENCENT_ASR_SECRET_ID=xxx
# TENCENT_ASR_SECRET_KEY=xxx
# TENCENT_ASR_APP_ID=xxx
```

重启后端服务。

#### 3.2 触发降级流程

1. 打开游戏，开始新游戏
2. 按住"按住说话"按钮
3. 说出"春眠不觉晓"
4. 松开按钮

**预期行为（Chrome 浏览器）：**

1. **录音阶段：**
   - ✅ 显示"🎤 录音中...请说话"
   - ✅ 计时器暂停

2. **腾讯云 ASR 尝试：**
   - ✅ 前端请求签名失败
   - ✅ Console 输出："腾讯云 ASR 识别失败: 获取签名失败"

3. **自动降级：**
   - ✅ Console 输出："降级到浏览器 Web Speech API"
   - ✅ 显示"🔍 语音识别中..."
   - ✅ 浏览器内置识别引擎启动

4. **识别完成：**
   - ✅ 输入框显示识别结果
   - ✅ 调用后端 LLM 验证
   - ✅ 计时器恢复或进入下一回合

### 测试 4: 降级触发条件测试

#### 4.1 腾讯云失败次数触发

在 `speechRecognitionService.ts` 中，降级条件是腾讯云失败 2 次。

**测试步骤：**

1. 确保后端签名服务正常
2. 第一次录音：正常使用腾讯云
3. 临时停止后端
4. 第二次录音：腾讯云失败（失败计数 +1）
5. 第三次录音：腾讯云再次失败（失败计数 +2）

**预期：** 第三次录音自动降级到浏览器识别

#### 4.2 用户手动选择降级

如果实现了用户设置选项：

```javascript
// 在游戏设置中
const options = {
  useBrowserFallback: true  // 强制使用浏览器识别
};
```

**预期：** 跳过腾讯云 ASR，直接使用浏览器识别

### 测试 5: 不同浏览器识别准确率对比

#### 5.1 准备测试诗句

选择 10 句常见诗句：

1. 春眠不觉晓
2. 白日依山尽
3. 床前明月光
4. 锄禾日当午
5. 野火烧不尽
6. 两个黄鹂鸣翠柳
7. 独在异乡为异客
8. 劝君更尽一杯酒
9. 春风又绿江南岸
10. 千山鸟飞绝

#### 5.2 在 Chrome 中测试

对每句诗进行识别，记录结果：

| 诗句 | 识别结果 | 准确 | 备注 |
|------|---------|------|------|
| 春眠不觉晓 | | ✅/❌ | |
| 白日依山尽 | | ✅/❌ | |
| ... | | | |

**统计：**
- 准确率: ___ / 10 = ___%
- 平均识别时间: ___ 秒

#### 5.3 在 Safari 中测试

重复上述测试，对比准确率差异。

#### 5.4 在 Edge 中测试

重复上述测试，对比准确率差异。

### 测试 6: 错误处理测试

#### 6.1 麦克风权限被拒绝

1. 浏览器设置中拒绝麦克风权限
2. 尝试语音识别

**预期：**
- ✅ 触发 `error` 事件
- ✅ 错误类型: `not-allowed`
- ✅ 显示错误提示: "麦克风权限被拒绝"
- ✅ 计时器恢复

#### 6.2 未检测到语音

1. 按住说话但保持静音
2. 超过 5 秒无声音

**预期：**
- ✅ 触发 `error` 事件
- ✅ 错误类型: `no-speech`
- ✅ 显示错误提示: "未检测到语音，请重试"
- ✅ 计时器恢复

#### 6.3 网络错误（浏览器识别）

部分浏览器需要网络连接进行语音识别。

1. 断开网络连接
2. 尝试识别

**预期（Chrome）：**
- ✅ 触发 `error` 事件
- ✅ 错误类型: `network`
- ✅ 显示错误提示: "网络连接失败，请检查网络"

### 测试 7: 降级提示测试

#### 7.1 UI 提示

当降级到浏览器识别时：

**预期显示：**
```
ℹ️ 当前使用浏览器内置识别，准确率可能较低，请清晰发音
```

#### 7.2 隐私提示

在某些浏览器（如 Chrome）中：

**预期显示：**
```
🔒 Chrome 浏览器可能会将语音数据发送到 Google 服务器进行处理，请注意隐私保护。
```

### 测试 8: 混合模式测试

#### 8.1 腾讯云恢复后自动切回

1. 使用浏览器识别完成一轮答题
2. 恢复后端服务
3. 下一轮继续录音

**预期：**
- ✅ 自动尝试腾讯云 ASR
- ✅ 腾讯云成功后，失败计数器重置
- ✅ 继续使用腾讯云识别

### 测试 9: 性能对比测试

#### 9.1 识别速度对比

测试同一句话在不同方式下的识别时间：

| 识别方式 | 识别时间 | 准确率 | 备注 |
|---------|---------|-------|------|
| 腾讯云 ASR | ___ 秒 | ___% | |
| Chrome Web Speech | ___ 秒 | ___% | |
| Safari Web Speech | ___ 秒 | ___% | |
| Edge Web Speech | ___ 秒 | ___% | |

#### 9.2 资源消耗对比

使用浏览器开发者工具 Performance 面板：

**腾讯云 ASR：**
- 网络请求: 2 次（签名 + ASR）
- 上传数据: ~100KB（音频 Base64）
- CPU 使用: 低

**浏览器 Web Speech：**
- 网络请求: 可能需要（取决于浏览器）
- 上传数据: 可能需要
- CPU 使用: 中等（浏览器内核处理）

## 测试检查清单

### 浏览器兼容性

- [ ] Chrome 支持检测正确
- [ ] Safari 支持检测正确
- [ ] Firefox 不支持提示正确
- [ ] Edge 支持检测正确

### 降级功能

- [ ] 腾讯云失败时自动降级
- [ ] 失败次数达到阈值触发降级
- [ ] 用户可手动选择浏览器识别
- [ ] 降级后能正常识别
- [ ] 降级后 LLM 验证正常

### 错误处理

- [ ] 麦克风权限拒绝错误处理
- [ ] 未检测到语音错误处理
- [ ] 网络错误处理
- [ ] 识别超时处理
- [ ] 所有错误后计时器恢复

### UI/UX

- [ ] 降级提示清晰
- [ ] 隐私提示显示
- [ ] 识别状态显示正确
- [ ] 计时器暂停/恢复正常

### 性能

- [ ] 浏览器识别响应时间 < 3s
- [ ] 不影响游戏流畅性
- [ ] 内存占用合理

## 常见问题排查

### 问题 1: 浏览器识别不工作

**可能原因：**
- 浏览器不支持 Web Speech API
- 麦克风权限未授权
- HTTPS 要求（部分浏览器）

**解决方案：**
- 使用 Chrome/Edge/Safari
- 检查浏览器权限设置
- 确保使用 HTTPS 或 localhost

### 问题 2: 识别准确率低

**可能原因：**
- 环境噪音
- 发音不清晰
- 浏览器识别引擎限制

**解决方案：**
- 在安静环境测试
- 说话清晰、语速适中
- 依赖 LLM 进行修正

### 问题 3: 降级未触发

**可能原因：**
- 失败计数未达到阈值
- useBrowserFallback 参数未设置

**解决方案：**
- 检查 tencentAsrFailCount 计数
- 确保 options.useBrowserFallback !== false

### 问题 4: Safari 识别异常

**可能原因：**
- Safari 对 Web Speech API 支持有限
- macOS/iOS 系统语音识别设置

**解决方案：**
- 检查系统语音识别设置
- 确保 Safari 版本 >= 14.1
- 考虑提示用户使用 Chrome

## 最佳实践建议

### 1. 降级策略

- ✅ 默认优先使用腾讯云 ASR（准确率更高）
- ✅ 失败 2 次后自动降级
- ✅ 提供用户手动选择选项
- ✅ 降级后不影响游戏体验

### 2. 用户提示

- ✅ 清晰说明当前使用的识别方式
- ✅ 提示浏览器识别准确率可能较低
- ✅ 给出改进建议（清晰发音）
- ✅ 显示隐私政策提示

### 3. 错误处理

- ✅ 所有错误都恢复计时器
- ✅ 错误信息清晰易懂
- ✅ 提供重试机制
- ✅ 记录错误日志便于排查

### 4. 性能优化

- ✅ 避免频繁切换识别方式
- ✅ 缓存浏览器支持检测结果
- ✅ 及时释放音频资源
- ✅ 监控识别时间，超时则取消

## 测试报告模板

```markdown
## 测试日期
YYYY-MM-DD

## 测试环境
- 浏览器：Chrome 120 / Safari 17 / Edge 120
- 操作系统：macOS 14.0 / Windows 11
- 麦克风：内置 / 外置

## 测试结果

### 浏览器支持
- Chrome: [ ] 通过 / [ ] 失败
- Safari: [ ] 通过 / [ ] 失败  
- Edge: [ ] 通过 / [ ] 失败
- Firefox: [ ] 正确提示不支持

### 降级功能
- [ ] 自动降级工作正常
- [ ] 手动选择工作正常
- 触发次数: ___ 次

### 识别准确率
- Chrome: ___% (___/10)
- Safari: ___% (___/10)
- Edge: ___% (___/10)

### 性能
- 平均识别时间: ___ 秒
- 内存占用: ___ MB

## 发现的问题
1. 
2. 

## 改进建议
1. 
2. 
```
